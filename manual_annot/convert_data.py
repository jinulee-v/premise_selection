import json
import os

import random
random.seed(0)

# Load versaprm.jsonl
print("cwd:", os.getcwd())
if "web" not in os.getcwd():
    print("Must execute in the web/")
    exit(1)
os.chdir("..")

# group by subject
subject_dict = {}
with open('data/versaprm.jsonl') as f:
    for line in f:
        datum = json.loads(line)
        subject = datum['metadata']['subject']
        source = datum['metadata']['source']
        if subject not in subject_dict:
            subject_dict[subject] = {}
        if source not in subject_dict[subject]:
            subject_dict[subject][source] = []
        subject_dict[subject][source].append(datum)

# Sort (subject, source) by descending counts
subject_source_counts = []
for subject in subject_dict:
    print(subject)
    for source in subject_dict[subject]:
        count = len(subject_dict[subject][source])
        subject_source_counts.append((count, subject, source))
subject_source_counts.sort(reverse=True)
# Print all (subject, source) counts
for count, subject, source in subject_source_counts:
    if subject == "math":
        print(f"{subject} | {source}: {count}")
    if subject == "physics":
        print(f"{subject} | {source}: {count}")
    if subject == "chemistry":
        print(f"{subject} | {source}: {count}")

# Sample math: 25, physics: 10, chemistry: 10, biology: 10, law: 10, health: 10
extracted_data = []
subject_limits = {
    "math": 25,
    "physics": 10,
    "chemistry": 10,
    "biology": 10,
    "law": 10,
    "health": 10
}
for subject in subject_limits:
    limit = subject_limits[subject]
    current_count = 0
    current_subject_data = []
    sources = list(subject_dict.get(subject, {}).keys())
    for source in sources:
        if "elementary" in source or "high_school" in source:
            continue
        current_source_data = subject_dict[subject][source]
        current_source_data = [x for x in current_source_data if len(x['steps']) >= 5]
        current_subject_data.extend(current_source_data)
    sample = random.sample(current_subject_data, min(limit, len(current_subject_data)))
    extracted_data.extend(sample)

print(f"Total extracted data: {len(extracted_data)}")

# Save each file to web/data with JSON format
"""
{
    "doc_id": "math_12_QwQ-32B-Preview_long_correct",
    "raw_text": {
        "question": "On Monday, Jessica told two friends a secret. On Tuesday, each of those friends told the secret to two other friends. Each time a student heard the secret, he or she told the secret to two other friends the following day. On what day of the week will 1023 students know the secret?",
        "response": "So I've got this problem here. Let's see what it's asking.\n\nOn Monday, Jessica told two friends a secret. On Tuesday, each of those friends told the secret to two other friends. And this pattern continues, where each student who hears the secret tells it to two other friends the following day.\n\nI need to find out on what day of the week 1023 students will know the secret.\n\nFirst, I should try to understand the pattern here.\n\nOn Monday:\n\n- Jessica tells two friends.\n\nSo, number of students who know the secret on Monday: 2.\n\nOn Tuesday:\n\n- Each of those two friends tells two others.\n\nSo, 2 * 2 = 4 new students know the secret.\n\nTotal students who know the secret now: original 2 + 4 = 6.\n\nWait, but the problem says \"each of those friends told the secret to two other friends.\" Does it mean that the original two tell two each, so four new students, making a total of six?\n\nYes, that makes sense.\n\nOn Wednesday:\n\n- Each of the four new students tells two others.\n\nSo, 4 * 2 = 8 new students.\n\nTotal students now: 6 + 8 = 14.\n\nOn Thursday:\n\n- Each of the eight new students tells two others.\n\n8 * 2 = 16 new students.\n\nTotal: 14 + 16 = 30.\n\nI see a pattern here.\n\nLet me try to generalize this.\n\nLet\u2019s consider the number of new students who learn the secret each day.\n\nOn day 1 (Monday): 2 students.\n\nOn day 2 (Tuesday): 4 new students.\n\nOn day 3 (Wednesday): 8 new students.\n\nOn day 4 (Thursday): 16 new students.\n\nIt looks like each day, the number of new students doubles.\n\nSo, on day n, the number of new students is 2^n.\n\nWait, on day 1: 2 = 2^1.\n\nDay 2: 4 = 2^2.\n\nDay 3: 8 = 2^3.\n\nDay 4: 16 = 2^4.\n\nThat seems consistent.\n\nNow, the total number of students who know the secret up to day n would be the sum of all new students from day 1 to day n.\n\nSo, total students = 2^1 + 2^2 + 2^3 + ... + 2^n.\n\nThis is a geometric series with first term a = 2, common ratio r = 2, and n terms.\n\nThe sum S of the first n terms of a geometric series is S = a * (r^n - 1)/(r - 1).\n\nPlugging in the values:\n\nS = 2 * (2^n - 1)/(2 - 1) = 2 * (2^n - 1)/1 = 2*(2^n - 1) = 2^{n+1} - 2.\n\nSo, total students who know the secret on day n: 2^{n+1} - 2.\n\nBut wait, let's verify this with the earlier totals.\n\nOn day 1: 2^{1+1} - 2 = 2^2 - 2 = 4 - 2 = 2. Correct.\n\nDay 2: 2^{3} - 2 = 8 - 2 = 6. Correct.\n\nDay 3: 2^{4} - 2 = 16 - 2 = 14. Correct.\n\nDay 4: 2^{5} - 2 = 32 - 2 = 30. Correct.\n\nGreat, so the formula is total students = 2^{n+1} - 2 on day n.\n\nNow, the problem asks for the day when 1023 students know the secret.\n\nSo, we set up the equation:\n\n2^{n+1} - 2 = 1023.\n\nLet's solve for n.\n\nFirst, add 2 to both sides:\n\n2^{n+1} = 1025.\n\nNow, we need to find n such that 2^{n+1} = 1025.\n\nBut 2^{10} = 1024, and 2^{11} = 2048.\n\n1025 is between 1024 and 2048, so n+1 must be 11, since 2^{11} = 2048, which is greater than 1025.\n\nWait, but 2^{10} = 1024, which is less than 1025.\n\nSo, 2^{n+1} = 1025 implies n+1 = 11, because 2^{11} = 2048, which is the smallest power of 2 greater than 1025.\n\nBut wait, 2^{10} = 1024, which is less than 1025, and 2^{11} = 2048, which is greater.\n\nSo, 2^{n+1} = 2048 implies n+1 = 11, so n = 10.\n\nBut according to our formula, total students = 2^{n+1} - 2.\n\nSo, on day n = 10, total students = 2^{11} - 2 = 2048 - 2 = 2046.\n\nBut we need the day when the total is 1023.\n\nWait, maybe I made a mistake earlier.\n\nLet me check the equation again.\n\nWe have 2^{n+1} - 2 = 1023.\n\nSo, 2^{n+1} = 1025.\n\nBut 2^{10} = 1024, which is less than 1025.\n\n2^{11} = 2048, which is greater.\n\nSo, there is no integer n that satisfies 2^{n+1} = 1025.\n\nWait a minute, maybe I need to think differently.\n\nPerhaps the total number of students who know the secret is 1023 includes Jessica herself.\n\nWait, the problem says \"Jessica told two friends a secret.\" It doesn't say that Jessica knows the secret; it just says she told two friends.\n\nBut probably, Jessica knows the secret.\n\nBut to be precise, let's assume that initially, only Jessica knows the secret, and she tells it to two friends on Monday.\n\nSo, on Monday, total students who know the secret: Jessica + 2 friends = 3.\n\nBut according to my earlier formula, on day 1, total students are 2.\n\nWait, maybe I need to adjust the formula.\n\nLet me re-examine.\n\nIf Jessica knows the secret on day 0, and on day 1 (Monday), she tells two friends.\n\nSo, day 1: 2 new students.\n\nTotal: 1 (Jessica) + 2 = 3.\n\nDay 2 (Tuesday): each of the two tells two others.\n\nSo, 2 * 2 = 4 new students.\n\nTotal: 3 + 4 = 7.\n\nDay 3 (Wednesday): each of the four tells two others.\n\n4 * 2 = 8 new students.\n\nTotal: 7 + 8 = 15.\n\nDay 4 (Thursday): each of the eight tells two others.\n\n8 * 2 = 16 new students.\n\nTotal: 15 + 16 = 31.\n\nI see a different pattern now.\n\nTotal students on day n: 2^{n+1} - 1.\n\nWait, let's check:\n\nDay 1: 2^{2} - 1 = 4 - 1 = 3. Correct.\n\nDay 2: 2^{3} - 1 = 8 - 1 = 7. Correct.\n\nDay 3: 2^{4} - 1 = 16 - 1 = 15. Correct.\n\nDay 4: 2^{5} - 1 = 32 - 1 = 31. Correct.\n\nSo, the correct formula is total students = 2^{n+1} - 1 on day n.\n\nTherefore, I need to solve 2^{n+1} - 1 = 1023.\n\nSo, 2^{n+1} = 1024.\n\nWe know that 2^{10} = 1024.\n\nTherefore, n+1 = 10, so n = 9.\n\nBut wait, let's check the days.\n\nIf day 1 is Monday, day 2 is Tuesday, day 3 is Wednesday, etc.\n\nThen day 9 would be:\n\nMonday (1), Tuesday (2), Wednesday (3), Thursday (4), Friday (5), Saturday (6), Sunday (7), Monday (8), Tuesday (9).\n\nSo, day 9 is Tuesday.\n\nBut wait, let's make sure about the starting day.\n\nIf day 1 is Monday, then:\n\nDay 1: Monday\n\nDay 2: Tuesday\n\nDay 3: Wednesday\n\nDay 4: Thursday\n\nDay 5: Friday\n\nDay 6: Saturday\n\nDay 7: Sunday\n\nDay 8: Monday\n\nDay 9: Tuesday\n\nDay 10: Wednesday\n\nBut according to the formula, n = 9 days from the start.\n\nBut perhaps I need to consider that the secret starts on Monday, and the counting starts from there.\n\nAlternatively, maybe I should consider day 0 as the day Jessica knew the secret, and day 1 as Monday when she tells two friends.\n\nLet me try that.\n\nDay 0: Jessica knows the secret.\n\nDay 1 (Monday): she tells two friends. Total students who know: 1 + 2 = 3.\n\nDay 2 (Tuesday): each of the two tells two others. 2 * 2 = 4 new. Total: 3 + 4 = 7.\n\nDay 3 (Wednesday): 4 * 2 = 8 new. Total: 7 + 8 = 15.\n\nDay 4 (Thursday): 8 * 2 = 16 new. Total: 15 + 16 = 31.\n\nDay 5 (Friday): 16 * 2 = 32 new. Total: 31 + 32 = 63.\n\nDay 6 (Saturday): 32 * 2 = 64 new. Total: 63 + 64 = 127.\n\nDay 7 (Sunday): 64 * 2 = 128 new. Total: 127 + 128 = 255.\n\nDay 8 (Monday): 128 * 2 = 256 new. Total: 255 + 256 = 511.\n\nDay 9 (Tuesday): 256 * 2 = 512 new. Total: 511 + 512 = 1023.\n\nSo, on day 9, which is Tuesday, the total number of students who know the secret is 1023.\n\nTherefore, the answer is Tuesday.\n\nBut wait, let's check the sequence again to make sure.\n\nDay 0: 1 (Jessica)\n\nDay 1: 1 + 2 = 3\n\nDay 2: 3 + 4 = 7\n\nDay 3: 7 + 8 = 15\n\nDay 4: 15 + 16 = 31\n\nDay 5: 31 + 32 = 63\n\nDay 6: 63 + 64 = 127\n\nDay 7: 127 + 128 = 255\n\nDay 8: 255 + 256 = 511\n\nDay 9: 511 + 512 = 1023\n\nYes, that's correct.\n\nSo, starting from Monday as day 1, day 9 is Tuesday.\n\nWait, but counting days:\n\nDay 1: Monday\n\nDay 2: Tuesday\n\nDay 3: Wednesday\n\nDay 4: Thursday\n\nDay 5: Friday\n\nDay 6: Saturday\n\nDay 7: Sunday\n\nDay 8: Monday\n\nDay 9: Tuesday\n\nYes, day 9 is Tuesday.\n\nTherefore, the answer is Tuesday.\n\n**Final Answer**\n\n\\[ \\boxed{\\text{Tuesday}} \\]"
    },
    "metadata": {
        "batch": 0,
        "domain": "math",
        "generator": "Qwen/QwQ-32B-Preview",
        "source": "NuminaMath"
    },
    "nodes": [
        {
            "id": "ctx0",
            "annotation": false,
            "start": 0,
            "end": 46,
            "label": "context",
            "text": "On Monday, Jessica told two friends a secret. ",
            "source": "question"
        },
        {
            "id": "trace0",
            "annotation": true,
            "start": 0,
            "end": 31,
            "label": "correct",
            "text": "So I've got this problem here. ",
            "source": "response"
        },
        ...
    ],
    "edges": []
}
"""

for datum in extracted_data:
    doc_id = datum['id']
    file_path = os.path.join('web', 'data', f"{doc_id}.json")
    # create nodes
    nodes = []
    # append question node
    nodes.append({
        "id": "ctx0",
        "annotation": False,
        "start": 0,
        "end": len(datum['question']),
        "label": "question",
        "text": datum['question'],
        "source": "question"
    })
    # append step nodes
    current_pos = 0
    label_dict = {
        1: "correct",
        0: "first_error",
        -1: None
    }
    for i, step in enumerate(datum['steps']):
        node = {
            "id": f"trace{i}",
            "annotation": True,
            "start": current_pos,
            "end": current_pos + len(step) + (2 if i < len(datum['steps']) - 1 else 0),  # account for "\n\n"
            "label": label_dict[datum['labels'][i]],  # default label
            "text": step,
            "source": "response"
        }
        nodes.append(node)
        current_pos += len(step) + (2 if i < len(datum['steps']) - 1 else 0)  # +2 for the "\n\n" added in response

    # final output
    final_datum = {
        "doc_id": datum['id'],
        "raw_text": {
            "question": datum['question'],
            "response": "\n\n".join(datum['steps'])
        },
        "metadata": datum['metadata'],
        "nodes": nodes,
        "edges": []
    }
    with open(file_path, 'w', encoding='utf-8') as f:
        json.dump(final_datum, f, indent=4)